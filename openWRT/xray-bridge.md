# Настройка Xray Bridge на OpenWRT роутере

> Данное руководство основано на статье ["XRay (с VLESS/XTLS): проброс портов, реверс-прокси, и псевдо-VPN"](https://habr.com/ru/articles/774838/), где подробно описывается концепция и принципы работы Xray в режиме реверс-прокси. В нашем руководстве мы рассмотрим практическую реализацию bridge на роутере с OpenWRT.

## Подготовка

Для установки вам потребуются:

- Роутер с OpenWRT
- Доступ к роутеру по SSH
- Файлы:
  - config.json (конфигурация Xray)
  - geoip.dat (база данных IP-адресов)
  - geosite.dat (база данных доменов)

## Пошаговая инструкция установки

### 1. Установка пакета

```bash
opkg update
opkg install xray-core
```

### 2. Копирование необходимых файлов

```bash
# Копирование баз данных
scp ./geoip.dat root@192.168.1.1:/usr/share/xray
scp ./geosite.dat root@192.168.1.1:/usr/share/xray

# Копирование конфигурации
scp ./config.json root@192.168.1.1:/etc/xray
```

### 3. Активация и запуск сервиса

```bash
# Включение сервиса
uci set xray.@xray[0].enabled='1'
uci commit xray

# Запуск сервиса
/etc/init.d/xray start
```

## Описание конфигурации

Предоставленная конфигурация настраивает Xray как мост со следующими особенностями:

1. **Режим моста (Bridge)**

   - Настроен для подключения к порталу `portal.ruru`
   - Позволяет организовать удаленный доступ к сети роутера

2. **Входящие соединения (Inbounds)**

   - SOCKS прокси на порту 10808
   - HTTP прокси на порту 10809
   - Оба интерфейса слушают только локальные подключения (127.0.0.1)

3. **Исходящие соединения (Outbounds)**

   - Основной прокси через VLESS с Reality протоколом
   - Прямое подключение (direct)
   - Блокировка нежелательного трафика (blackhole)

4. **Маршрутизация (Routing)**
   - Трафик для `portal.ruru` направляется через прокси
   - Остальной трафик идет напрямую

## Проверка работоспособности

После установки можно проверить статус сервиса:

```bash
/etc/init.d/xray status
```

Просмотр логов:

```bash
logread | grep xray
```

## Преимущества данной конфигурации

1. Безопасный удаленный доступ к локальной сети роутера через зашифрованное соединение
2. Возможность доступа к интернету через роутер для удаленных клиентов
3. Использование современного протокола VLESS с Reality для повышенной безопасности
4. Гибкая маршрутизация трафика

## Возможные проблемы и их решение

1. Если сервис не запускается:

```bash
# Проверка конфигурации
/usr/bin/xray -test -config /etc/xray/config.json

# Просмотр логов
logread | grep xray
```

2. Если нет доступа к порталу:

- Проверьте правильность настроек Reality (publicKey, serverName, shortId)
- Убедитесь, что порт 443 доступен

## Управление сервисом

### Остановка сервиса

```bash
# Остановка xray
/etc/init.d/xray stop

# Отключение автозапуска
uci set xray.@xray[0].enabled='0'
uci commit xray
```

### Перезапуск сервиса

```bash
/etc/init.d/xray restart

# Или более мягкий вариант перезапуска
/etc/init.d/xray reload
```

## Удаление

### 1. Остановка и отключение сервиса

```bash
/etc/init.d/xray stop
/etc/init.d/xray disable
```

### 2. Удаление пакета

```bash
opkg remove xray-core
```

### 3. Удаление конфигурационных файлов (опционально)

```bash
rm -rf /etc/xray
rm -rf /usr/share/xray
rm /etc/config/xray
```

После этих действий Xray будет полностью удален из системы. Если планируете переустановку в будущем, рекомендуется сохранить копию вашего конфигурационного файла.
